# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

name: Build and Release

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: write
  packages: write

env:
  # Path to the solution file relative to the root of the project.
  SOLUTION_FILE_PATH: GTA5_DMA\GTA5_DMA.sln

  # Configuration type to build.
  BUILD_CONFIGURATION: Release
  PLATFORM: x64

jobs:
  build:
    runs-on: windows-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get Version
      id: get_version
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        else
          echo "version=v$(date +'%Y%m%d.%H%M%S')" >> $GITHUB_OUTPUT
        fi

    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v1.0.2

    - name: Restore NuGet packages
      working-directory: ${{env.GITHUB_WORKSPACE}}
      run: nuget restore ${{env.SOLUTION_FILE_PATH}}

    - name: Download MemProcFS Library
      working-directory: ${{env.GITHUB_WORKSPACE}}
      run: |
        # 下载 MemProcFS 库文件
        Invoke-WebRequest -Uri "https://github.com/ufrisk/MemProcFS/releases/latest/download/MemProcFS-Release.zip" -OutFile "MemProcFS.zip"
        Expand-Archive -Path "MemProcFS.zip" -DestinationPath "."
        # 复制所需的库文件到 MemProcFS 目录
        Copy-Item -Path ".\MemProcFS\vmm.lib" -Destination "${{env.GITHUB_WORKSPACE}}/GTA5_DMA/MemProcFS/" -Force
        Copy-Item -Path ".\MemProcFS\vmm.dll" -Destination "${{env.GITHUB_WORKSPACE}}/GTA5_DMA/MemProcFS/" -Force
        Copy-Item -Path ".\MemProcFS\leechcore.dll" -Destination "${{env.GITHUB_WORKSPACE}}/GTA5_DMA/MemProcFS/" -Force
        # 清理临时文件
        Remove-Item -Path "MemProcFS.zip" -Force
        Remove-Item -Path ".\MemProcFS" -Recurse -Force

    - name: Build
      working-directory: ${{env.GITHUB_WORKSPACE}}
      run: msbuild.exe ${{env.SOLUTION_FILE_PATH}} /t:Build /p:Configuration=${{env.BUILD_CONFIGURATION}} /p:Platform=${{env.PLATFORM}}

    - name: Prepare Release Files
      run: |
        $BUILD_OUTPUT = "${{env.GITHUB_WORKSPACE}}/GTA5_DMA/x64/${{env.BUILD_CONFIGURATION}}/"
        $RELEASE_DIR = "${{env.GITHUB_WORKSPACE}}/release/"
        
        # 创建发布目录
        New-Item -Path $RELEASE_DIR -ItemType Directory -Force
        
        # 复制主要可执行文件
        Copy-Item -Path "$BUILD_OUTPUT/GTA5_DMA.exe" -Destination $RELEASE_DIR -Force
        
        # 复制必要的 DLL 文件
        Copy-Item -Path "$BUILD_OUTPUT/vmm.dll" -Destination $RELEASE_DIR -Force
        Copy-Item -Path "$BUILD_OUTPUT/leechcore.dll" -Destination $RELEASE_DIR -Force
        
        # 复制其他可能需要的文件
        Get-ChildItem -Path $BUILD_OUTPUT -Filter "*.dll" | Copy-Item -Destination $RELEASE_DIR -Force
        
        # 复制 README 文件
        Copy-Item -Path "${{env.GITHUB_WORKSPACE}}/README.md" -Destination $RELEASE_DIR -Force
        Copy-Item -Path "${{env.GITHUB_WORKSPACE}}/LICENSE" -Destination $RELEASE_DIR -Force

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: GTA5_DMA-Build-${{env.BUILD_CONFIGURATION}}-${{ steps.get_version.outputs.version }}
        path: ${{env.GITHUB_WORKSPACE}}/release/
        retention-days: 30

    - name: Upload to GitHub Releases
      if: github.ref_type == 'tag'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref }}
        name: Release ${{ github.ref }}
        body: |
          ## What's Changed
          
          - Auto-generated release
          - Build: ${{ github.sha }}
          - Date: ${{ steps.get_version.outputs.version }}
        files: ${{env.GITHUB_WORKSPACE}}/release/*
        draft: false
        prerelease: false

